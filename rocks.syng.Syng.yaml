id: rocks.syng.Syng
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
base: com.riverbankcomputing.PyQt.BaseApp
base-version: '6.10'
cleanup-commands:
  - /app/cleanup-BaseApp.sh
build-options:
  env:
    - BASEAPP_REMOVE_WEBENGINE=1
finish-args:
  - --env=QTWEBENGINEPROCESS_PATH=/app/bin/QtWebEngineProcess
  # X11 + XShm access
  - --socket=fallback-x11
  - --share=ipc
  - --socket=wayland
  # Acceleration
  - --device=dri
  # Sound
  - --socket=pulseaudio
  # Playback files from anywhere on the system
  - --filesystem=host:ro
  - --share=network
cleanup:
  - '*.la'
  - '*.a'
command: syng
modules:
  # MPV and MPV deps
  # This is basically copied from the mpv flatpak
  - name: libXmu
    buildsystem: autotools
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libxmu.git
        tag: libXmu-1.3.1
        commit: cdf280f6611932f79ab872832974e8043b1cad6d
        x-checker-data:
          type: git
          tag-pattern: ^libXmu-([\d.]+)$

  - name: xclip
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/astrand/xclip.git
        tag: '0.13'
        commit: 9aa7090c3b8b437c6489edca32ae43d82e0c1281
        x-checker-data:
          type: git
          tag-pattern: ^(\d+\.\d+)$

  - name: libXpresent
    buildsystem: autotools
    sources:
      - type: git
        url: https://gitlab.freedesktop.org/xorg/lib/libxpresent.git
        tag: libXpresent-1.0.1
        commit: 37507b5f44332accfb1064ee69a4f6a833994747

  - name: luajit
    no-autogen: true
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
    sources:
      - type: git
        url: https://github.com/LuaJIT/LuaJIT.git
        disable-shallow-clone: true
        commit: 2090842410e0ba6f81fad310a77bf5432488249a
      - type: shell
        commands:
          - sed -i 's|/usr/local|/app|' ./Makefile

  - name: yt-dlp-ejs
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app yt_dlp_ejs*.whl
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/a4/90/8911146822364666be47f184c4180cec20fcc537a268ef40d1ab077dd25b/yt_dlp_ejs-0.4.0-py3-none-any.whl
        sha256: 19278cff397b243074df46342bb7616c404296aeaff01986b62b4e21823b0b9c
        x-checker-data:
          type: pypi
          name: yt-dlp-ejs
          packagetype: bdist_wheel

  - name: yt-dlp
    no-autogen: true
    no-make-install: true
    make-args:
      - yt-dlp
      - PYTHON=/usr/bin/python3
    post-install:
      - install yt-dlp /app/bin
    sources:
      - type: archive
        url: https://github.com/yt-dlp/yt-dlp/releases/download/2026.01.31/yt-dlp.tar.gz
        sha256: 928639b0355c2ee40af7b574e47a3c00048756e405f7964a7b39d70fe0cda4ba
        x-checker-data:
          type: json
          url: https://api.github.com/repos/yt-dlp/yt-dlp/releases/latest
          version-query: .tag_name
          url-query: .assets[] | select(.name=="yt-dlp.tar.gz") | .browser_download_url

  - name: libass
    cleanup:
      - /include
      - /lib/pkgconfig
    config-opts:
      - --disable-static
    sources:
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.4
        commit: bbb3c7f1570a4a021e52683f3fbdf74fe492ae84
        x-checker-data:
          type: git
          tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$

  - name: zimg
    config-opts:
      - --disable-static
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/doc
    sources:
      - type: archive
        archive-type: tar
        url: https://api.github.com/repos/sekrit-twc/zimg/tarball/release-3.0.6
        sha256: 15140e491c4ce9db5f02a038d8a1eb53e9151b55eeed06a2899425a6ebfef367
        x-checker-data:
          type: json
          url: https://api.github.com/repos/sekrit-twc/zimg/releases/latest
          url-query: .tarball_url
          version-query: .tag_name | sub("^release-"; "")
          timestamp-query: .published_at
  - name: vulkan-headers
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/KhronosGroup/Vulkan-Headers/archive/v1.4.306.tar.gz
        sha256: 18f4b4de873d071ddd7b73ea48e2ec4e7c6133e2ebb6b4236ca2345acd056994
  - name: libplacebo
    buildsystem: meson
    config-opts:
      - -Dvulkan=enabled
      - -Dshaderc=disabled
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/haasn/libplacebo.git
        tag: v7.351.0
        commit: 3188549fba13bbdf3a5a98de2a38c2e71f04e21e
      - type: patch
        path: patches/libplacebo-vulkan-python-xml.patch
  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dlibmpv=true
      - -Dmanpage-build=disabled
      - -Dlibarchive=enabled
      - -Dshaderc=disabled
      - -Dvulkan=enabled
    cleanup:
      - /include
      - /lib/pkgconfig
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.41.0
        commit: 41f6a645068483470267271e1d09966ca3b9f413
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
  - name: libzen
    subdir: Project/GNU/Library
    config-opts:
      - --enable-shared
      - --disable-static
    sources:
      - type: archive
        url: https://mediaarea.net/download/source/libzen/0.4.41/libzen_0.4.41.tar.xz
        sha256: 933bad3b7ecd29dc6bdc88a83645c83dfd098c15b0b90d6177a37fa1536704e8
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.la
  - name: libmediainfo
    subdir: Project/GNU/Library
    config-opts:
      - --enable-shared
      - --disable-static
    sources:
      - type: git
        url: https://github.com/MediaArea/MediaInfoLib.git
        tag: v25.10
        commit: a7860aab31a47f0d09549c6dafc329c5816d96c7
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /lib/*.la
  - name: deno
    buildsystem: simple
    build-commands:
      - install -Dm755 deno /app/bin/deno
    sources:
      # -------- x86_64 build --------
      - type: file
        only-arches:
          - x86_64
        url: https://github.com/denoland/deno/releases/download/v2.5.6/deno-x86_64-unknown-linux-gnu.zip
        sha256: fd4f6abc1b6a134fa9a4dba56519f1631f44c88e04e4e3e9a8ff5975dfa66e1a
        dest-filename: deno.zip

      # -------- aarch64 build --------
      - type: file
        only-arches:
          - aarch64
        url: https://github.com/denoland/deno/releases/download/v2.5.6/deno-aarch64-unknown-linux-gnu.zip
        sha256: f5e60ae3dfceb61e5e5a41f22129e40a8bc17f6393b59e75d7ca19ceef32d824
        dest-filename: deno.zip

      # -------- unpack the zip --------
      - type: shell
        commands:
          - unzip deno.zip

  - python3-uv-build.yaml
  - python3-expandvars.yaml
  - python3-cffi.yaml
  - python3-pdm-backend.yaml
  - python3-pybind11.yaml
  - python3-requirements-client.yaml
  - name: syng
    buildsystem: simple
    build-commands:
      - pip install --prefix=/app --no-deps . --no-build-isolation
      - install -Dm644 resources/${FLATPAK_ID}.desktop -t /app/share/applications
      - install -Dm644 resources/flatpak/${FLATPAK_ID}.metainfo.xml -t /app/share/metainfo
      - install -Dm644 resources/icons/hicolor/32x32/apps/${FLATPAK_ID}.png /app/share/icons/hicolor/32x32/apps/${FLATPAK_ID}.png
      - install -Dm644 resources/icons/hicolor/48x48/apps/${FLATPAK_ID}.png /app/share/icons/hicolor/48x48/apps/${FLATPAK_ID}.png
      - install -Dm644 resources/icons/hicolor/64x64/apps/${FLATPAK_ID}.png /app/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.png
      - install -Dm644 resources/icons/hicolor/128x128/apps/${FLATPAK_ID}.png /app/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 resources/icons/hicolor/256x256/apps/${FLATPAK_ID}.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -Dm644 resources/icons/hicolor/512x512/apps/${FLATPAK_ID}.png /app/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      # - install -Dm644 resources/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg /app/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg 
    sources:
      - type: git
        url: https://github.com/christofsteel/syng.git
        commit: 2d0752bd00dcf0aa6356b0879fd05ab33ab19c10
